<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>P2P Chat</title>
<style>
body { font-family: monospace; background:#111; color:#0f0; display:flex; flex-direction:column; align-items:center; padding:20px;}
textarea, input { width:400px; margin:5px 0; font-family: monospace;}
#messages { width:400px; height:200px; overflow-y:auto; border:1px solid #0f0; padding:5px; margin-bottom:10px;}
</style>
</head>
<body>
<h2>P2P Chat без сервера</h2>
<div id="messages"></div>
<input id="input" placeholder="Введите сообщение и нажмите Enter">
<button onclick="createOffer()">Создать Offer</button>
<textarea id="offer" placeholder="Offer / Answer" rows="5"></textarea>
<button onclick="acceptOffer()">Принять Offer</button>
<button onclick="acceptAnswer()">Принять Answer</button>

<script>
let pc;
let channel;
let remoteId = "peer";

const messages = document.getElementById("messages");
const input = document.getElementById("input");
const offerTextarea = document.getElementById("offer");

function log(msg){
  const d=document.createElement("div"); d.textContent=msg; messages.appendChild(d);
  messages.scrollTop = messages.scrollHeight;
}

/* ===== Создаем offer ===== */
function createOffer(){
  pc = new RTCPeerConnection();
  channel = pc.createDataChannel("chat");
  setupChannel();
  pc.onicecandidate = e=>{ if(e.candidate) console.log("ICE candidate:", JSON.stringify(e.candidate)); };
  pc.createOffer().then(offer=>{
    pc.setLocalDescription(offer);
    offerTextarea.value = JSON.stringify(offer);
    log("Offer создан! Скопируйте и отправьте другому игроку.");
  });
}

/* ===== Принимаем offer ===== */
function acceptOffer(){
  const offer = JSON.parse(offerTextarea.value);
  pc = new RTCPeerConnection();
  pc.ondatachannel = ev=>{ channel = ev.channel; setupChannel(); };
  pc.onicecandidate = e=>{ if(e.candidate) console.log("ICE candidate:", JSON.stringify(e.candidate)); };
  pc.setRemoteDescription(new RTCSessionDescription(offer)).then(()=>{
    pc.createAnswer().then(answer=>{
      pc.setLocalDescription(answer);
      offerTextarea.value = JSON.stringify(answer);
      log("Answer создан! Отправьте обратно создателю offer.");
    });
  });
}

/* ===== Принимаем answer ===== */
function acceptAnswer(){
  const answer = JSON.parse(offerTextarea.value);
  pc.setRemoteDescription(new RTCSessionDescription(answer));
  log("Соединение установлено!");
}

/* ===== Настройка канала ===== */
function setupChannel(){
  channel.onopen = ()=>log("Канал открыт!");
  channel.onmessage = e=>log("Peer: "+e.data);
}

/* ===== Отправка сообщений ===== */
input.addEventListener("keydown", e=>{
  if(e.key==="Enter" && input.value.trim()!==""){
    const msg = input.value.trim();
    channel.send(msg);
    log("Me: "+msg);
    input.value="";
  }
});
</script>
</body>
</html>
